#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
#


"daemon"


from bot.spec import Cfg, Object, Storage
from bot.spec import daemon, forever, privileges, scan


class Table(Object):

    modules = Object()

    @staticmethod
    def add(module):
        Table.modules[name] = module

    @staticmethod
    def get(fqn):
        return getattr(Table.modules, fqn, None)

    @staticmethod
    def init(self):
        for module in values(Table.modules):
            if "init" in dir(module):
                try:
                    module.init()
                except Exception as ex:
                    Errors.add(ex)

    @staticmethod
    def scan(path):
        mns = []
        for fnm in os.listdir(path):
            if fnm.startswith("__"):
                continue
            fnn = fnm[:-3]
            pname = fnn.split(os.sep)[-2]
            fqn = f"{pname}.{fnn}"
            mod = importlib.import_module(fqn, pname)
            Table.add(mod)
            Storage.scan(mod)
            Handler.scan(mod)



daemon(Cfg.pidfile)
privileges(Cfg.user)
Table.scan(Storage.mods())
forever()
