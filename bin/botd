#!/usr/bin/env python3
# This file is placed in the Public Domain.
#
#


"daemon"


import os
import importlib

from bot.spec import Cfg, Object, Handler, Storage
from bot.spec import daemon, forever, mods, privileges


Cfg.mod = ",".join(mods(Cfg.md))
Storage.wd = Cfg.wd


def scan(path, modnames, init=False):
    mns = []
    if not os.path.exists(path):
        return mns
    pname = path.split(os.sep)[-1]
    for fnm in os.listdir(path):
        if fnm.startswith("__"):
            continue
        if not fnm.endswith(".py"):
            continue
        fnn = fnm[:-3]
        fqn = f"{pname}.{fnn}"
        mod = importlib.import_module(fqn, pname)
        mns.append(fqn)
        Storage.scan(mod)
        Handler.scan(mod)
        if init and "init" in dir(mod):
            try:
                mod.init()
            except Exception as ex:
                Errors.add(ex)
    return mns


daemon(Cfg.pidfile)
privileges(Cfg.user)
scan(Storage.mods(), Cfg.mod, True)
forever()
